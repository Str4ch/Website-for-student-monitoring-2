select final.STUDENT_CONTACT_REF, final.CONTACT_FIRST_NAME, final.CONTACT_LAST_NAME, final.passed, final.allll
from
(
select grd.GRADE_STUDENT_EPITA_EMAIL_REF, grd.STUDENT_CONTACT_REF, grd.STUDENT_POPULATION_PERIOD_REF, grd.STUDENT_POPULATION_YEAR_REF, grd.STUDENT_POPULATION_CODE_REF, grd.CONTACT_FIRST_NAME, grd.CONTACT_LAST_NAME, count(case when grd.SUMM > 10 then 1 end) as passed, count(*) as allll from
(
select *, g.summm/g.couuunt as summ
from
(
select GRADE_STUDENT_EPITA_EMAIL_REF, GRADE_COURSE_CODE_REF,cn.COURSE_NAME, sum(GRADE_SCORE) as summm, count(GRADE_SCORE) as couuunt  from GRADES
join (select COURSE_CODE, COURSE_NAME  from COURSES) as cn where cn.COURSE_CODE  = GRADE_COURSE_CODE_REF
group by GRADE_COURSE_CODE_REF, GRADE_STUDENT_EPITA_EMAIL_REF
order by GRADE_STUDENT_EPITA_EMAIL_REF
)as g
join STUDENTS on g.GRADE_STUDENT_EPITA_EMAIL_REF = STUDENT_EPITA_EMAIL
join CONTACTS on STUDENT_CONTACT_REF = CONTACT_EMAIL
) as grd
group by grd.GRADE_STUDENT_EPITA_EMAIL_REF, grd.STUDENT_CONTACT_REF, grd.STUDENT_POPULATION_PERIOD_REF, grd.STUDENT_POPULATION_YEAR_REF, grd.STUDENT_POPULATION_CODE_REF, grd.CONTACT_FIRST_NAME, grd.CONTACT_LAST_NAME
) as final
where final.STUDENT_CONTACT_REF = '%s'