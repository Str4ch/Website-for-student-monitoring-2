select fin.STUDENT_POPULATION_CODE_REF, fin.STUDENT_POPULATION_YEAR_REF, fin.STUDENT_POPULATION_PERIOD_REF, CAST(fin.summ*100/fin.count as INT) as percents from
(
SELECT att.STUDENT_POPULATION_CODE_REF, att.STUDENT_POPULATION_PERIOD_REF, att.STUDENT_POPULATION_YEAR_REF, sum(att.ATTENDANCE_PRESENCE) as summ, COUNT(*) as count
from(
SELECT a.ATTENDANCE_PRESENCE, ss.STUDENT_POPULATION_CODE_REF, ss.STUDENT_POPULATION_PERIOD_REF, ss.STUDENT_POPULATION_YEAR_REF   FROM ATTENDANCE as a
inner join  (select STUDENT_EPITA_EMAIL, STUDENT_POPULATION_CODE_REF, STUDENT_POPULATION_PERIOD_REF, STUDENT_POPULATION_YEAR_REF    from STUDENTS) as ss
where ss.STUDENT_EPITA_EMAIL = a.ATTENDANCE_STUDENT_REF ) as att
group by att.STUDENT_POPULATION_CODE_REF, att.STUDENT_POPULATION_PERIOD_REF, att.STUDENT_POPULATION_YEAR_REF
) as fin
ORDER BY percents desc